---
title: 'How to Measure the Current of ESP32 Devices'
description: "Tutorial on how to properly measure the enery consumption of ESP32 devices running OpenThread."
date: 2025-06-5
draft: false
---

import Callout from "@/components/Callout.astro";

---

The energy consumption of a device is especially important when those devices are Internet of Things (IoT) devices. This fact applies to devices running ESP32 hardware as well.

However, you cannot just simply measure the current of an ESP32 device by simply connecting it to an oscilloscope or anmeter of your choice. If you are not careful, you may even risk damaging the device.

To the best of my knowledge, there are not many resources that explain how to properly measure the current of ESP32 microcontrollers. 

In this guide, I would like to share what I learned in the process of measuring the energy usage of my own ESP32 devices, references to other resources that I found helpful, and common pitfalls to avoid.

<Callout type="info">
  In this tutorial, I will specifically be using an [ESP32-H2 devkit](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html). Although I never measured the current of other devices beyond the ESP32-H2, I believe the steps in this tutorial should still apply to other ESP32 devkits that contain a [J5 Header](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#current-measurement) (such as an [ESP32-C6](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitc-1/user_guide.html)). 
</Callout>

## Choosing the Right Measurement Tool

You *can* measure the current of an ESP32 device using an oscilloscope. However, doing so is challenging, since oscilloscopes measure *voltage*, not current. To do so, you will need to *indirectly* measure the current by measuring the voltage drop of the device. Even then, you may not even get fully accurate measurements when your ESP32 device is operating at really low currents, such as during deep sleep, due to noise. 

Oscilloscope are *not* designed for this task. They are really good at measuring voltage at really low timescales (e.g. in the range of micro- or nanoseconds), but they are not good at measuring voltage when the voltages are really small (e.g. in the range of microvolts). As a result, obtaining the current through the voltage drop measured by an oscilloscope will not get us far.

To measure currents, especially really low currents, we will need to look for other tools. To find these tools, we need not look further than the [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/stable/esp32h2/api-guides/current-consumption-measurement-modules.html#how-to-choose-an-appropriate-ammeter):

> Therefore, an ammeter suitable for measuring current in Deep-sleep mode should have low internal resistance and, ideally, switch current ranges dynamically. We recommend two options: the Joulescope ammeter and the Power Profiler Kit II from Nordic.

In this tutorial, I will be using the [Nordic Power Profiler Kit II (PPK2)](https://www.nordicsemi.com/Products/Development-hardware/Power-Profiler-Kit-2).

<figure>
  <img src="/images/esp32-energy/digilent-ad3-current.png" />
  <figcaption>
    As an example of the limitations of oscilloscopes when measuring really low currents, shown above are waveforms displayed when measuring the deep sleep current of an ESP32-H2 using the Digilent [Analog Discovery 3 (AD3)](https://digilent.com/shop/analog-discovery-3/) oscilloscope, with the [AD3 Current & Power Adapter](https://digilent.com/shop/current-and-power-adapter/) extension. The expected deep sleep current of the ESP32 should be ~7 uA, but the AD3, with the Current & Power Adapter,  [can only measure at around ~350 uA granularity](https://forum.digilent.com/topic/29202-how-to-use-the-ad3-current-power-adapter-on-an-esp32-h2/).
  </figcaption>
</figure>

<figure>
  <img src="/images/esp32-energy/ppk2-current.png" /> 
  <figcaption>
    More accurate waveforms are obtained when measuring the deep sleep current of an ESP32-H2 using the PPK2.
  </figcaption>
</figure>

{/* TODOs:
      1. Write diagram to show how to connect ESP32 with PPK2. Use a footnote to cite
         pictures you did not make in the diagram.

      2. Reference Circuit Digest video that taught you how to connect ESP32 to PPK2:
         https://www.youtube.com/watch?v=47Jsqma_KYg

      3. Add pictures to show that you can connect the ESP32 to PPK2 using the J5 pins
         or the 3.3V pin.
*/}

## How to *Not* Measure Low Currents

You set up an ESP32-H2 with the PPK2 by using jumper wires to connect:

 * the `VCC` port of the PPK2 to the `5V0` [^1] pin of the ESP32 device, and
 * the `GND` port of the PPK2 to `GND` pin on the ESP32.

In this configuration, you can use the PPK2 to measure the current of the ESP32-H2 while the PPK2 itself is providing 5V of power. This is how I initially approached the measurement of my ESP32-H2 device.

However, this approach will *not* work when the ESP32-H2 is consuming really low currents in the uA range: the PPK2 will report much higher currents than expected.

When measuring the deep sleep current of my ESP32-H2 when it ran the [ESP32 OpenThread boilerplate deep sleep SED program](https://github.com/espressif/esp-idf/tree/master/examples/openthread/ot_sleepy_device/deep_sleep), the PPK2 reported a current of ~1.25 mA, when it should have instead measured the current at ~7 uA, the expected value of the deep sleep current for an ESP32-H2 [^2].

<figure>
  <img src="/images/esp32-energy/esp32-inaccurate-deep-sleep-current.png" /> 
  <figcaption>
    When the ESP32-H2 runs to the [ESP32 OpenThread boilerplate deep sleep SED program](https://github.com/espressif/esp-idf/tree/master/examples/openthread/ot_sleepy_device/deep_sleep) and has its `5V0` pin connected to the `VCC` port of the PPK2, the current measured by the PPK2 is around ~1.25 mA, rather than ~7 uA.
  </figcaption>
</figure>

### The J5 Header

These inaccurate low current measurements occur when the [**J5 header**](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#current-measurement) pin of the ESP32-H2 has *not* been removed.

<figure>
  <img src="/images/esp32-energy/esp32h2-j5-header.png" /> 
  <figcaption>
    The J5 header pin of the ESP32-H2. The power-on LED if off when the J5 header pin was removed, even though the ESP32-H2 module itself is having its power supplied by USB.
  </figcaption>
</figure>

<Callout type="error">
  In the picture above shown in the right, I showed my ESP32-H2 with the J5 header pin while its UART port was connected to USB. **DO NOT DO THIS![^4] Removing the J5 header from an ESP32-H2 while it is being supplied with 5V of power [could damage the device](https://esp32.com/viewtopic.php?t=40052#p132759)**. As I will discuss later, you will need to supply the ESP32-H2 with 3.3V of power when the J5 header is removed. Even though I did not measure the current of other ESP32 devices, I believe this warning will still apply to any ESP32 devkits which contains a J5 header (such as the [ESP32-C6](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitc-1/user_guide.html#current-measurement)).
</Callout>

In order to accurately measure the current of an ESP32-H2, the J5 header pin will need to be removed [^3] from the ESP32-H2 for the duration in which the PPK2 is measuring the current of the device.

## Measuring Small Currents the Correct Way

To properly measure low currents using the PPK2, we will need to the following setup:

* Connect the `VCC` port of the PPK2 to the `3V3`[^5] pin of the ESP32-H2.

* Connect the `GND` port of the PPK2 to the `GND` pin of the ESP32-H2.


{/* ## Measuring Current the Right Way

## Helpful Resources */}

---
[^1]: According to the [ESP32-H2 GPIO pin layout diagram](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#pin-layout), the `5V0` GPIO pin is used to provide 5V of power to the ESP32-H2. Since the [`5V0` pin also appears in the ESP32-C6](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitc-1/user_guide.html#pin-layout), I use the notation `5V0` to generally refer to the GPIO pin that allows an ESP32 device to be supplied with 5V of power.

[^2]: Table 5-9 of the[ ESP32-H2 datasheet](https://www.espressif.com/sites/default/files/documentation/esp32-h2_datasheet_en.pdf) states that the expected deep sleep current for the device is 7 uA. Furthermore, the screenshot shown in the `README` for the [ESP32 OpenThread boilerplate deep sleep SED program](https://github.com/espressif/esp-idf/tree/master/examples/openthread/ot_sleepy_device/deep_sleep) shows that when the [Joulescope energy analyzer](https://www.joulescope.com/) was used to measure the deep sleep current of an ESP32 802.15.4 device running the program, it reported currents in ~7-8 uA range.

[^3]: I learned about the purpose of the J5 header from the [ESP32-H2 Devkit documentation](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#current-measurement), and in the [converstion I had with Espressif engineer `Sprite` on the ESP32 forums](https://esp32.com/viewtopic.php?t=40052).

[^4]: At the time I took the picture, I did not know that powering my ESP32-H2 under 5V while the J5 header was removed would cause any issue. It was not until I talked to [Espressif engineer `Sprite` on the ESP32 forums](https://esp32.com/viewtopic.php?t=40052#p132759) that doing so could damage my ESP32-H2 device.

[^5]: According to the [ESP32-H2 GPIO pin layout diagram](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#pin-layout), the `3V3` GPIO pin is used to provide 3.3V of power to the ESP32-H2. Since the [`3V3` pin also appears in the ESP32-C6](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitc-1/user_guide.html#pin-layout), I use the notation `3V3` to generally refer to the GPIO pin that allows an ESP32 device to be supplied with 3.3 of power.