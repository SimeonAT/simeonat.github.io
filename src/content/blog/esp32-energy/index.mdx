---
title: 'How to Measure the Current of ESP32 Devices'
description: "Tutorial on how to properly measure the enery consumption of ESP32 devices running OpenThread."
date: 2024-06-5
draft: false
---

import Callout from "@/components/Callout.astro";

---

The energy consumption of a device is especially important when those devices are Internet of Things (IoT) devices. This fact applies to devices running ESP32 hardware as well.

However, you cannot just simply measure the current of an ESP32 device by simply connecting it to an oscilloscope, Nordic Power Profiler Kit II, Joulescope, or your measurement device of choice. If you are not careful, you may even risk damaging the device.

To the best of my knowledge, there are not many resources that explain how to properly measure the current of ESP32 microcontrollers. 

In this guide, I would like to share what I learned in the process of measuring the energy usage of my own ESP32 devices, references to resources that I found helpful, and common pitfalls to avoid.

<Callout type="info">
  In this tutorial, I will be using specifically be using an [ESP32-H2 devkit](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html). Although I never measured the current of other devices beyond the ESP32-H2, I believe the steps in this tutorial should still apply to other ESP32 devkits that contain a [J5 Header](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32h2/esp32-h2-devkitm-1/user_guide.html#current-measurement) (such as an [ESP32-C6](https://espressif-docs.readthedocs-hosted.com/projects/esp-dev-kits/en/latest/esp32c6/esp32-c6-devkitc-1/user_guide.html)). 
</Callout>

## Choosing the Right Measurement Kit

You *can* measure the current of an ESP32 device using an oscilloscope. However, doing so is challenging, since oscilloscopes measure *voltage*, not current. To do so, you will need to *indirectly* measure the current by measuring the voltage drop of the device, and you will will need to set up a simple DC circuit in order to do so. Even then, you may not even get fully accurate measurements when you ESP32 device is operating at really low currents, such as during deep sleep, due to noise. 

Oscilloscope are *not* designed for this task. They are really good at measuring voltage at really low timescales (e.g. in the range of micro- or nanoseconds), but they are not good at measuring voltages at really low timescales (e.g. in the range of microvolts).

To measure currents, especially really low currents, you will need to look for other tools. To find these tools, we not need look further than the [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/stable/esp32h2/api-guides/current-consumption-measurement-modules.html#how-to-choose-an-appropriate-ammeter):

> Therefore, an ammeter suitable for measuring current in Deep-sleep mode should have low internal resistance and, ideally, switch current ranges dynamically. We recommend two options: the Joulescope ammeter and the Power Profiler Kit II from Nordic.

In this tutorial, I will be using the Nordic Power Profiler Kit II (PPK2).

<figure>
  <img src="/images/esp32-energy/digilent-ad3-current.png" />
  <figcaption>
    The waveforms displayed when measuring the deep sleep current of an ESP32 using the Digilent Analog Discovery 3 (AD3) oscilloscope, with the AD3 Current & Power Adapter extension. The expected deep sleep current of the ESP32 should be ~7 uA, but the noise prevents waveforms from being shown at uA granularity.
  </figcaption>
</figure>

  {/* <img src="/images/esp32-energy/ppk2-current.png" /> */}